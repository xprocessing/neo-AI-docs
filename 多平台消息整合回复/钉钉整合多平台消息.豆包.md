
通过webhook，服务器用php+mysql，聊天软件用钉钉， 接入ebay ，亚马逊，shopify 买家消息，支持回复信息。 给实现流程和代码，要求支持多平台多店铺接入，支持方便修改钉钉负责人




# PHP+MySQL+Webhook多店铺接入电商平台消息至钉钉（支持回复+负责人配置）
## 一、整体架构设计
### 核心逻辑（多店铺+负责人配置）
```
# 1. 消息接收流程
多店铺Webhook（带店铺ID）→ PHP服务端 → 验证店铺身份 → MySQL存储（消息+关联店铺）→ 根据店铺配置推送至指定钉钉负责人/群 → 钉钉展示

# 2. 回复消息流程
钉钉回复（带消息ID）→ PHP接收 → 关联店铺获取API配置 → 调用对应店铺的平台API回复 → MySQL更新状态 → 通知钉钉负责人回复结果

# 3. 负责人配置流程
后台管理页面 → 配置店铺-钉钉负责人关联 → 实时生效（无需修改代码）
```
### 核心依赖
- 环境：PHP 7.4+（curl/json/openssl扩展）、MySQL 5.7+、Nginx/Apache（HTTPS）
- 前置准备：
  1. 钉钉自定义机器人（加签）+ 钉钉企业内部应用（获取用户ID/部门ID）
  2. 各平台多店铺开发者账号+API授权（eBay/亚马逊/Shopify）
  3. 服务器需备案（公网HTTPS访问）

## 二、数据库表设计（多店铺+负责人核心）
### 1. 店铺表（ecommerce_shops）- 存储多店铺配置
```sql
CREATE TABLE `ecommerce_shops` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '店铺ID',
  `shop_name` varchar(50) NOT NULL COMMENT '店铺名称（如：Shopify美国店/亚马逊欧洲店）',
  `platform` varchar(20) NOT NULL COMMENT '平台（ebay/amazon/shopify）',
  `platform_shop_id` varchar(100) NOT NULL COMMENT '平台店铺唯一ID',
  `api_config` text NOT NULL COMMENT '平台API配置（JSON格式，存储各平台密钥/token）',
  `dingtalk_responsible_ids` varchar(200) DEFAULT '' COMMENT '钉钉负责人ID（多个用,分隔）',
  `dingtalk_group_token` varchar(200) DEFAULT '' COMMENT '钉钉群机器人token（可选，推送到群）',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '1=启用 0=禁用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `platform_shop_id` (`platform`,`platform_shop_id`),
  KEY `status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电商店铺配置表';
```

### 2. 消息表（ecommerce_messages）- 关联店铺+负责人
```sql
CREATE TABLE `ecommerce_messages` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增ID',
  `shop_id` int(11) NOT NULL COMMENT '关联店铺ID',
  `platform` varchar(20) NOT NULL COMMENT '平台（ebay/amazon/shopify）',
  `platform_msg_id` varchar(100) NOT NULL COMMENT '平台消息唯一ID',
  `buyer_id` varchar(50) NOT NULL COMMENT '买家ID',
  `buyer_name` varchar(50) DEFAULT '' COMMENT '买家名称',
  `order_id` varchar(50) DEFAULT '' COMMENT '关联订单号',
  `msg_content` text NOT NULL COMMENT '买家消息内容',
  `msg_time` datetime NOT NULL COMMENT '买家发消息时间',
  `dingtalk_push_ids` varchar(200) DEFAULT '' COMMENT '已推送的钉钉负责人ID',
  `status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '0=未回复 1=已回复',
  `reply_content` text DEFAULT '' COMMENT '回复内容',
  `reply_time` datetime DEFAULT NULL COMMENT '回复时间',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `platform_msg_id` (`platform`,`platform_msg_id`),
  KEY `shop_id` (`shop_id`),
  KEY `status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='电商买家消息表（多店铺）';
```

### 3. 钉钉负责人表（dingtalk_users）- 管理钉钉用户
```sql
CREATE TABLE `dingtalk_users` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增ID',
  `dingtalk_user_id` varchar(50) NOT NULL COMMENT '钉钉用户唯一ID（userid）',
  `user_name` varchar(50) NOT NULL COMMENT '钉钉用户名',
  `mobile` varchar(20) DEFAULT '' COMMENT '手机号',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '1=启用 0=禁用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `dingtalk_user_id` (`dingtalk_user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='钉钉负责人表';
```

## 三、核心配置文件（config.php）
```php
<?php
// 数据库基础配置（通用）
define('DB_HOST', '你的MySQL主机');
define('DB_USER', '你的MySQL用户名');
define('DB_PASS', '你的MySQL密码');
define('DB_NAME', '你的数据库名');

// 钉钉全局配置
define('DINGTALK_CORP_ID', '你的钉钉企业CorpID'); // 企业内部应用获取
define('DINGTALK_APP_KEY', '你的钉钉企业应用AppKey');
define('DINGTALK_APP_SECRET', '你的钉钉企业应用AppSecret');
define('DINGTALK_REPLY_URL', 'https://你的域名/dingtalk_reply.php'); // 回复页面地址
define('DINGTALK_API_URL', 'https://oapi.dingtalk.com'); // 钉钉开放平台地址

// 日志配置
define('LOG_PATH', __DIR__ . '/logs/');
// 确保日志目录存在
if (!is_dir(LOG_PATH)) mkdir(LOG_PATH, 0755, true);
?>
```

## 四、数据库操作封装（db.php）
```php
<?php
require_once 'config.php';

// 数据库连接
function connectDB() {
    $conn = mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME);
    if (!$conn) {
        writeLog('数据库连接失败: ' . mysqli_connect_error(), 'error');
        die("数据库连接失败");
    }
    mysqli_set_charset($conn, 'utf8mb4');
    return $conn;
}

// 日志记录（按日期分文件）
function writeLog($content, $type = 'info') {
    $filename = LOG_PATH . date('Ymd') . '_' . $type . '.log';
    $content = date('Y-m-d H:i:s') . ' | ' . $type . ' | ' . $content . PHP_EOL;
    file_put_contents($filename, $content, FILE_APPEND);
}

// 1. 店铺相关操作
// 获取店铺信息（通过店铺ID）
function getShopById($shop_id) {
    $conn = connectDB();
    $sql = "SELECT * FROM ecommerce_shops WHERE id=? AND status=1";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, 'i', $shop_id);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    $shop = mysqli_fetch_assoc($result);
    // 解析JSON格式的API配置
    if ($shop) $shop['api_config'] = json_decode($shop['api_config'], true);
    mysqli_stmt_close($stmt);
    mysqli_close($conn);
    return $shop;
}

// 更新店铺钉钉负责人
function updateShopDingtalk($shop_id, $responsible_ids, $group_token = '') {
    $conn = connectDB();
    $sql = "UPDATE ecommerce_shops SET dingtalk_responsible_ids=?, dingtalk_group_token=?, update_time=NOW() WHERE id=?";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, 'ssi', $responsible_ids, $group_token, $shop_id);
    $result = mysqli_stmt_execute($stmt);
    mysqli_stmt_close($stmt);
    mysqli_close($conn);
    writeLog("店铺ID:{$shop_id} 更新钉钉负责人:{$responsible_ids} 群token:{$group_token}");
    return $result;
}

// 获取所有店铺列表
function getAllShops() {
    $conn = connectDB();
    $sql = "SELECT * FROM ecommerce_shops ORDER BY id DESC";
    $result = mysqli_query($conn, $sql);
    $shops = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $row['api_config'] = json_decode($row['api_config'], true);
        $shops[] = $row;
    }
    mysqli_close($conn);
    return $shops;
}

// 2. 消息相关操作
// 插入消息（关联店铺）
function insertMessage($data) {
    $conn = connectDB();
    $sql = "INSERT IGNORE INTO ecommerce_messages 
            (shop_id, platform, platform_msg_id, buyer_id, buyer_name, order_id, msg_content, msg_time, dingtalk_push_ids)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, 'issssssss', 
        $data['shop_id'],
        $data['platform'],
        $data['platform_msg_id'],
        $data['buyer_id'],
        $data['buyer_name'],
        $data['order_id'],
        $data['msg_content'],
        $data['msg_time'],
        $data['dingtalk_push_ids']
    );
    $result = mysqli_stmt_execute($stmt);
    if (!$result) writeLog('插入消息失败: ' . mysqli_error($conn), 'error');
    mysqli_stmt_close($stmt);
    mysqli_close($conn);
    return $result;
}

// 更新消息回复状态
function updateMessageReply($msg_id, $reply_content) {
    $conn = connectDB();
    $sql = "UPDATE ecommerce_messages 
            SET status=1, reply_content=?, reply_time=NOW() 
            WHERE id=?";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, 'si', $reply_content, $msg_id);
    $result = mysqli_stmt_execute($stmt);
    mysqli_stmt_close($stmt);
    mysqli_close($conn);
    writeLog("消息ID:{$msg_id} 回复内容:{$reply_content}");
    return $result;
}

// 获取消息详情（含店铺信息）
function getMessageWithShop($msg_id) {
    $conn = connectDB();
    $sql = "SELECT m.*, s.shop_name, s.api_config 
            FROM ecommerce_messages m 
            LEFT JOIN ecommerce_shops s ON m.shop_id = s.id 
            WHERE m.id=?";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, 'i', $msg_id);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    $data = mysqli_fetch_assoc($result);
    if ($data) $data['api_config'] = json_decode($data['api_config'], true);
    mysqli_stmt_close($stmt);
    mysqli_close($conn);
    return $data;
}

// 3. 钉钉负责人操作
// 添加/更新钉钉用户
function saveDingtalkUser($user_id, $user_name, $mobile = '') {
    $conn = connectDB();
    // 先查是否存在
    $sql = "SELECT id FROM dingtalk_users WHERE dingtalk_user_id=?";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, 's', $user_id);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    if (mysqli_num_rows($result) > 0) {
        // 更新
        $sql = "UPDATE dingtalk_users SET user_name=?, mobile=?, update_time=NOW() WHERE dingtalk_user_id=?";
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, 'sss', $user_name, $mobile, $user_id);
    } else {
        // 新增
        $sql = "INSERT INTO dingtalk_users (dingtalk_user_id, user_name, mobile) VALUES (?, ?, ?)";
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, 'sss', $user_id, $user_name, $mobile);
    }
    $result = mysqli_stmt_execute($stmt);
    mysqli_stmt_close($stmt);
    mysqli_close($conn);
    writeLog("钉钉用户:{$user_id} 姓名:{$user_name} 保存成功");
    return $result;
}

// 获取所有钉钉负责人
function getAllDingtalkUsers() {
    $conn = connectDB();
    $sql = "SELECT * FROM dingtalk_users WHERE status=1 ORDER BY id DESC";
    $result = mysqli_query($conn, $sql);
    $users = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $users[] = $row;
    }
    mysqli_close($conn);
    return $users;
}
?>
```

## 五、钉钉API封装（dingtalk_api.php）
```php
<?php
require_once 'db.php';

// 获取钉钉企业应用access_token
function getDingtalkAccessToken() {
    $cache_file = LOG_PATH . 'dingtalk_token.cache';
    // 缓存1小时（钉钉token有效期7200秒）
    if (file_exists($cache_file) && time() - filemtime($cache_file) < 3600) {
        return file_get_contents($cache_file);
    }
    $url = DINGTALK_API_URL . '/gettoken?appkey=' . DINGTALK_APP_KEY . '&appsecret=' . DINGTALK_APP_SECRET;
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $result = json_decode(curl_exec($ch), true);
    curl_close($ch);
    if ($result['errcode'] != 0) {
        writeLog('获取钉钉token失败: ' . json_encode($result), 'error');
        return '';
    }
    // 写入缓存
    file_put_contents($cache_file, $result['access_token']);
    return $result['access_token'];
}

// 推送消息给钉钉用户/群（支持多负责人）
function sendToDingtalk($shop, $messageData) {
    $token = getDingtalkAccessToken();
    if (!$token) return false;

    $msg_id = $messageData['id'];
    $shop_name = $shop['shop_name'];
    $responsible_ids = explode(',', $shop['dingtalk_responsible_ids']); // 多负责人ID
    $group_token = $shop['dingtalk_group_token']; // 群机器人token

    // 1. 推送至钉钉群（如果配置了群token）
    if ($group_token) {
        $timestamp = time() * 1000;
        $signStr = $timestamp . "\n" . $shop['dingtalk_secret']; // 群机器人加签密钥（店铺表可扩展此字段）
        $sign = urlencode(base64_encode(hash_hmac('sha256', $signStr, $shop['dingtalk_secret'], true)));
        $group_url = "https://oapi.dingtalk.com/robot/send?access_token={$group_token}&timestamp={$timestamp}&sign={$sign}";
        
        $card = [
            'msgtype' => 'actionCard',
            'actionCard' => [
                'title' => "【{$shop_name}新消息】ID:{$msg_id}",
                'text' => "### 平台：{$messageData['platform']}\n".
                          "### 买家：{$messageData['buyer_name']}（ID:{$messageData['buyer_id']}）\n".
                          "### 订单：{$messageData['order_id']}\n".
                          "### 内容：\n{$messageData['msg_content']}\n".
                          "### 时间：{$messageData['msg_time']}",
                'singleTitle' => '回复此消息',
                'singleURL' => DINGTALK_REPLY_URL . "?msg_id={$msg_id}"
            ]
        ];
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $group_url);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($card, JSON_UNESCAPED_UNICODE));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        $group_result = json_decode(curl_exec($ch), true);
        curl_close($ch);
        writeLog("钉钉群推送结果: " . json_encode($group_result));
    }

    // 2. 推送至钉钉个人（多负责人）
    foreach ($responsible_ids as $user_id) {
        if (empty($user_id)) continue;
        $url = DINGTALK_API_URL . '/message/send_to_conversation?access_token=' . $token;
        $data = [
            'sender' => DINGTALK_APP_KEY,
            'cid' => $user_id, // 钉钉用户ID
            'msg' => [
                'msgtype' => 'text',
                'text' => [
                    'content' => "【{$shop_name}新消息】\nID:{$msg_id}\n买家：{$messageData['buyer_name']}\n内容：{$messageData['msg_content']}\n回复地址：" . DINGTALK_REPLY_URL . "?msg_id={$msg_id}"
                ]
            ]
        ];
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data, JSON_UNESCAPED_UNICODE));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        $result = json_decode(curl_exec($ch), true);
        curl_close($ch);
        writeLog("推送钉钉用户{$user_id}结果: " . json_encode($result));
    }
    return true;
}

// 获取钉钉用户列表（从钉钉平台同步）
function syncDingtalkUsers() {
    $token = getDingtalkAccessToken();
    if (!$token) return false;
    $url = DINGTALK_API_URL . '/user/list?access_token=' . $token . '&department_id=1&fetch_child=true';
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $result = json_decode(curl_exec($ch), true);
    curl_close($ch);
    if ($result['errcode'] != 0) {
        writeLog('同步钉钉用户失败: ' . json_encode($result), 'error');
        return false;
    }
    // 保存到数据库
    foreach ($result['userlist'] as $user) {
        saveDingtalkUser($user['userid'], $user['name'], $user['mobile'] ?? '');
    }
    return true;
}
?>
```

## 六、多平台多店铺Webhook接收（webhook_receive.php）
```php
<?php
require_once 'db.php';
require_once 'dingtalk_api.php';
require_once 'platform_api.php';

// 获取请求参数（核心：shop_id区分店铺）
$shop_id = $_GET['shop_id'] ?? 0;
$platform = $_GET['platform'] ?? '';
$rawBody = file_get_contents('php://input');

// 验证店铺是否存在
$shop = getShopById($shop_id);
if (!$shop) {
    writeLog("无效店铺ID:{$shop_id} 平台:{$platform}", 'error');
    http_response_code(403);
    exit(json_encode(['code' => 403, 'msg' => '无效店铺']));
}

writeLog("店铺ID:{$shop_id} 平台:{$platform} 接收数据:{$rawBody}");

// 各平台签名验证+数据解析
$messageData = [];
switch ($platform) {
    case 'shopify':
        // Shopify签名验证（使用店铺专属API配置）
        $hmacHeader = $_SERVER['HTTP_X_SHOPIFY_HMAC_SHA256'] ?? '';
        $calculatedHmac = base64_encode(hash_hmac('sha256', $rawBody, $shop['api_config']['access_token'], true));
        if ($hmacHeader !== $calculatedHmac) {
            writeLog("Shopify店铺{$shop_id}签名验证失败", 'error');
            http_response_code(403);
            exit(json_encode(['code' => 403, 'msg' => '签名失败']));
        }
        $data = json_decode($rawBody, true);
        $messageData = [
            'shop_id' => $shop_id,
            'platform' => 'shopify',
            'platform_msg_id' => $data['id'] ?? uniqid('shopify_'),
            'buyer_id' => $data['customer']['id'] ?? 'unknown',
            'buyer_name' => $data['customer']['first_name'] . ' ' . $data['customer']['last_name'] ?? '未知',
            'order_id' => $data['order_id'] ?? '',
            'msg_content' => $data['body'] ?? '',
            'msg_time' => date('Y-m-d H:i:s', strtotime($data['created_at'] ?? 'now')),
            'dingtalk_push_ids' => $shop['dingtalk_responsible_ids']
        ];
        break;

    case 'amazon':
        // 亚马逊签名验证（简化版，生产需完整AWS4验证）
        $authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? '';
        if (empty($authHeader) || !strpos($authHeader, 'AWS4-HMAC-SHA256')) {
            writeLog("亚马逊店铺{$shop_id}签名验证失败", 'error');
            http_response_code(403);
            exit(json_encode(['code' => 403, 'msg' => '签名失败']));
        }
        $data = json_decode($rawBody, true);
        $messageData = [
            'shop_id' => $shop_id,
            'platform' => 'amazon',
            'platform_msg_id' => $data['messageId'] ?? uniqid('amazon_'),
            'buyer_id' => $data['buyer']['buyerId'] ?? 'unknown',
            'buyer_name' => $data['buyer']['buyerName'] ?? '未知',
            'order_id' => $data['orderId'] ?? '',
            'msg_content' => $data['content']['text'] ?? '',
            'msg_time' => date('Y-m-d H:i:s', strtotime($data['creationDate'] ?? 'now')),
            'dingtalk_push_ids' => $shop['dingtalk_responsible_ids']
        ];
        break;

    case 'ebay':
        // eBay签名验证
        $ebaySignature = $_SERVER['HTTP_X_EBAY_SIGNATURE'] ?? '';
        $calculatedSign = hash_hmac('sha256', $rawBody, $shop['api_config']['cert_id']);
        if ($ebaySignature !== $calculatedSign) {
            writeLog("eBay店铺{$shop_id}签名验证失败", 'error');
            http_response_code(403);
            exit(json_encode(['code' => 403, 'msg' => '签名失败']));
        }
        $data = json_decode($rawBody, true);
        $messageData = [
            'shop_id' => $shop_id,
            'platform' => 'ebay',
            'platform_msg_id' => $data['messageId'] ?? uniqid('ebay_'),
            'buyer_id' => $data['buyer']['userId'] ?? 'unknown',
            'buyer_name' => $data['buyer']['username'] ?? '未知',
            'order_id' => $data['transactionId'] ?? '',
            'msg_content' => $data['message']['content'] ?? '',
            'msg_time' => date('Y-m-d H:i:s', strtotime($data['creationTime'] ?? 'now')),
            'dingtalk_push_ids' => $shop['dingtalk_responsible_ids']
        ];
        break;

    default:
        writeLog("未知平台:{$platform} 店铺ID:{$shop_id}", 'error');
        http_response_code(400);
        exit(json_encode(['code' => 400, 'msg' => '未知平台']));
}

// 插入消息到数据库
insertMessage($messageData);
// 获取插入后的消息ID
$messageData['id'] = mysqli_insert_id(connectDB());
// 推送至钉钉
sendToDingtalk($shop, $messageData);

http_response_code(200);
exit(json_encode(['code' => 200, 'msg' => '成功']));
?>
```

## 七、多平台回复API封装（platform_api.php）
```php
<?php
require_once 'db.php';

// 统一回复入口（多店铺多平台）
function replyToPlatform($msg_id, $reply_content) {
    $msg = getMessageWithShop($msg_id);
    if (!$msg) return ['code' => -1, 'msg' => '消息不存在'];
    $shop_id = $msg['shop_id'];
    $platform = $msg['platform'];
    $api_config = $msg['api_config']; // 店铺专属API配置

    // 根据平台调用对应回复方法
    switch ($platform) {
        case 'shopify':
            $result = replyShopify($msg, $api_config, $reply_content);
            break;
        case 'amazon':
            $result = replyAmazon($msg, $api_config, $reply_content);
            break;
        case 'ebay':
            $result = replyEbay($msg, $api_config, $reply_content);
            break;
        default:
            $result = ['code' => -2, 'msg' => '不支持的平台'];
    }

    // 更新回复状态
    if ($result['code'] == 0) {
        updateMessageReply($msg_id, $reply_content);
    } else {
        writeLog("回复失败 消息ID:{$msg_id} 原因:{$result['msg']}", 'error');
    }
    return $result;
}

// Shopify回复（多店铺独立配置）
function replyShopify($msg, $api_config, $reply_content) {
    $url = "https://{$api_config['shop_domain']}/admin/api/{$api_config['api_version']}/customer_notes/{$msg['platform_msg_id']}/replies.json";
    $data = ['reply' => ['body' => $reply_content]];
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'X-Shopify-Access-Token: ' . $api_config['access_token']
    ]);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $result = json_decode(curl_exec($ch), true);
    curl_close($ch);
    if (isset($result['errors'])) {
        return ['code' => -3, 'msg' => 'Shopify回复失败: ' . json_encode($result['errors'])];
    }
    return ['code' => 0, 'msg' => '回复成功'];
}

// 亚马逊回复（多店铺独立配置）
function replyAmazon($msg, $api_config, $reply_content) {
    $url = "https://sellingpartnerapi-{$api_config['region']}.amazon.com/messaging/v1/sellers/{$api_config['seller_id']}/messages/{$msg['platform_msg_id']}/replies";
    $data = ['content' => ['text' => $reply_content]];
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Authorization: Bearer ' . $api_config['access_token']
    ]);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $result = json_decode(curl_exec($ch), true);
    curl_close($ch);
    if (isset($result['errors'])) {
        return ['code' => -4, 'msg' => '亚马逊回复失败: ' . json_encode($result['errors'])];
    }
    return ['code' => 0, 'msg' => '回复成功'];
}

// eBay回复（多店铺独立配置）
function replyEbay($msg, $api_config, $reply_content) {
    $xml = '<?xml version="1.0" encoding="utf-8"?>
    <AddMemberMessageAAQToPartnerRequest xmlns="urn:ebay:apis:eBLBaseComponents">
        <RequesterCredentials>
            <eBayAuthToken>' . $api_config['auth_token'] . '</eBayAuthToken>
        </RequesterCredentials>
        <ItemID>' . $msg['order_id'] . '</ItemID>
        <MemberMessage>
            <Body>' . htmlspecialchars($reply_content) . '</Body>
            <RecipientID>' . $msg['buyer_id'] . '</RecipientID>
            <MessageType>ContactSeller</MessageType>
        </MemberMessage>
    </AddMemberMessageAAQToPartnerRequest>';

    $url = "https://api.ebay.com/ws/api.dll?callname=AddMemberMessageAAQToPartner&siteid={$api_config['site_id']}&appid={$api_config['app_id']}&version=967";
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $xml);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: text/xml',
        'X-EBAY-API-DEV-NAME: ' . $api_config['dev_id'],
        'X-EBAY-API-CERT-NAME: ' . $api_config['cert_id']
    ]);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $result = simplexml_load_string(curl_exec($ch));
    curl_close($ch);
    if (isset($result->Errors)) {
        return ['code' => -5, 'msg' => 'eBay回复失败: ' . $result->Errors->LongMessage];
    }
    return ['code' => 0, 'msg' => '回复成功'];
}
?>
```

## 八、钉钉回复页面（dingtalk_reply.php）
```php
<?php
require_once 'db.php';
require_once 'platform_api.php';

$msg_id = $_GET['msg_id'] ?? 0;
$msg = getMessageWithShop($msg_id);
$error = '';
$success = '';

// 处理回复提交
if ($_POST) {
    $reply_content = trim($_POST['reply_content'] ?? '');
    if (empty($msg_id) || empty($reply_content)) {
        $error = '消息ID和回复内容不能为空';
    } elseif (!$msg) {
        $error = '消息不存在';
    } elseif ($msg['status'] == 1) {
        $error = '此消息已回复，无法重复提交';
    } else {
        $result = replyToPlatform($msg_id, $reply_content);
        if ($result['code'] == 0) {
            $success = '回复成功！已同步至【' . $msg['shop_name'] . '】平台';
            $msg['status'] = 1; // 刷新状态
            $msg['reply_content'] = $reply_content;
        } else {
            $error = '回复失败：' . $result['msg'];
        }
    }
}
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>回复买家消息 - <?php echo $msg['shop_name'] ?? '未知店铺'; ?></title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .card { border: 1px solid #e6e6e6; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        textarea { width: 100%; padding: 10px; border: 1px solid #e6e6e6; border-radius: 4px; min-height: 120px; }
        button { background: #007bff; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .success { color: #28a745; padding: 10px; background: #f8fff8; border-radius: 4px; margin-bottom: 20px; }
        .error { color: #dc3545; padding: 10px; background: #fff8f8; border-radius: 4px; margin-bottom: 20px; }
        .info { color: #6c757d; font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>回复买家消息</h1>
    
    <?php if ($success) echo "<div class='success'>{$success}</div>"; ?>
    <?php if ($error) echo "<div class='error'>{$error}</div>"; ?>

    <?php if ($msg): ?>
    <div class="card">
        <h3>消息详情</h3>
        <p><strong>所属店铺：</strong><?php echo $msg['shop_name']; ?></p>
        <p><strong>平台：</strong><?php echo $msg['platform']; ?></p>
        <p><strong>买家：</strong><?php echo $msg['buyer_name']; ?>（ID:<?php echo $msg['buyer_id']; ?>）</p>
        <p><strong>关联订单：</strong><?php echo $msg['order_id'] ?: '无'; ?></p>
        <p><strong>买家消息：</strong><br><?php echo nl2br($msg['msg_content']); ?></p>
        <p><strong>消息时间：</strong><?php echo $msg['msg_time']; ?></p>
        <?php if ($msg['status'] == 1): ?>
        <p><strong>已回复内容：</strong><br><?php echo nl2br($msg['reply_content']); ?></p>
        <p><strong>回复时间：</strong><?php echo $msg['reply_time']; ?></p>
        <?php endif; ?>
    </div>

    <?php if ($msg['status'] == 0): ?>
    <form method="post">
        <input type="hidden" name="msg_id" value="<?php echo $msg_id; ?>">
        <div class="form-group">
            <label for="reply_content">回复内容：</label>
            <textarea name="reply_content" id="reply_content" required placeholder="请输入回复内容（支持多语言）..."></textarea>
            <div class="info">注：回复内容将同步至<?php echo $msg['platform']; ?>平台，请确保符合平台规则</div>
        </div>
        <button type="submit">提交回复</button>
    </form>
    <?php else: ?>
    <p style="color: #999;">此消息已完成回复，无法再次提交</p>
    <?php endif; ?>

    <?php else: ?>
    <div class="error">未找到ID为<?php echo $msg_id; ?>的消息，请检查链接是否正确</div>
    <?php endif; ?>
</body>
</html>
```

## 九、店铺&钉钉负责人管理后台（admin.php）
```php
<?php
require_once 'db.php';
require_once 'dingtalk_api.php';

// 权限验证（简单版，生产需增加登录）
$admin_key = $_GET['key'] ?? '';
if ($admin_key != '你的管理密钥') { // 替换为自定义密钥
    die("无访问权限");
}

// 同步钉钉用户
if ($_GET['action'] == 'sync_dingtalk') {
    syncDingtalkUsers();
    header('Location: admin.php?key=' . $admin_key);
    exit;
}

// 更新店铺钉钉配置
if ($_POST['action'] == 'update_shop') {
    $shop_id = $_POST['shop_id'];
    $responsible_ids = implode(',', $_POST['responsible_ids'] ?? []);
    $group_token = $_POST['group_token'];
    updateShopDingtalk($shop_id, $responsible_ids, $group_token);
    header('Location: admin.php?key=' . $admin_key . '&success=1');
    exit;
}

$shops = getAllShops();
$dingtalk_users = getAllDingtalkUsers();
$success = $_GET['success'] ?? 0;
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>多店铺配置管理后台</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { background: #007bff; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .btn-success { background: #28a745; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        table th, table td { border: 1px solid #e6e6e6; padding: 10px; text-align: left; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 600px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #e6e6e6; border-radius: 4px; }
        .success { color: #28a745; padding: 10px; background: #f8fff8; border-radius: 4px; margin-bottom: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>多店铺配置管理</h1>
        <a href="?key=<?php echo $admin_key; ?>&action=sync_dingtalk" class="btn btn-success">同步钉钉用户</a>
    </div>

    <?php if ($success): ?>
    <div class="success">配置更新成功！</div>
    <?php endif; ?>

    <table>
        <tr>
            <th>店铺ID</th>
            <th>店铺名称</th>
            <th>平台类型</th>
            <th>当前钉钉负责人</th>
            <th>钉钉群Token</th>
            <th>操作</th>
        </tr>
        <?php foreach ($shops as $shop): ?>
        <tr>
            <td><?php echo $shop['id']; ?></td>
            <td><?php echo $shop['shop_name']; ?></td>
            <td><?php echo $shop['platform']; ?></td>
            <td>
                <?php 
                $responsible_ids = explode(',', $shop['dingtalk_responsible_ids']);
                foreach ($dingtalk_users as $user) {
                    if (in_array($user['dingtalk_user_id'], $responsible_ids)) {
                        echo $user['user_name'] . ' ';
                    }
                }
                ?>
            </td>
            <td><?php echo $shop['dingtalk_group_token'] ?: '未配置'; ?></td>
            <td>
                <button class="btn edit-btn" data-shop='<?php echo json_encode($shop); ?>'>修改负责人</button>
            </td>
        </tr>
        <?php endforeach; ?>
    </table>

    <!-- 修改负责人弹窗 -->
    <div class="modal hidden" id="editModal">
        <div class="modal-content">
            <h3>修改店铺钉钉配置</h3>
            <form method="post">
                <input type="hidden" name="action" value="update_shop">
                <input type="hidden" name="shop_id" id="modal_shop_id">
                <div class="form-group">
                    <label>店铺名称</label>
                    <input type="text" id="modal_shop_name" disabled>
                </div>
                <div class="form-group">
                    <label>钉钉负责人（可多选）</label>
                    <select name="responsible_ids[]" multiple size="5">
                        <?php foreach ($dingtalk_users as $user): ?>
                        <option value="<?php echo $user['dingtalk_user_id']; ?>"><?php echo $user['user_name'] . '(' . $user['mobile'] . ')'; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label>钉钉群机器人Token（可选）</label>
                    <input type="text" name="group_token" id="modal_group_token" placeholder="输入钉钉群机器人access_token">
                </div>
                <button type="submit" class="btn">保存配置</button>
                <button type="button" class="btn btn-cancel" style="background: #6c757d; margin-left: 10px;">取消</button>
            </form>
        </div>
    </div>

    <script>
        // 编辑按钮点击事件
        const editBtns = document.querySelectorAll('.edit-btn');
        const modal = document.getElementById('editModal');
        const cancelBtn = document.querySelector('.btn-cancel');

        editBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const shop = JSON.parse(btn.dataset.shop);
                document.getElementById('modal_shop_id').value = shop.id;
                document.getElementById('modal_shop_name').value = shop.shop_name;
                document.getElementById('modal_group_token').value = shop.dingtalk_group_token || '';
                
                // 选中当前负责人
                const responsibleIds = shop.dingtalk_responsible_ids.split(',');
                const selectOptions = document.querySelectorAll('select[name="responsible_ids[]"] option');
                selectOptions.forEach(option => {
                    option.selected = responsibleIds.includes(option.value);
                });

                modal.classList.remove('hidden');
            });
        });

        // 取消按钮
        cancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // 点击空白处关闭弹窗
        window.addEventListener('click', (e) => {
            if (e.target == modal) {
                modal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
```

## 十、部署与使用流程
### 1. 初始化配置
1. 导入上述4张数据库表（ecommerce_shops/ecommerce_messages/dingtalk_users）
2. 上传所有PHP文件至HTTPS服务器，修改`config.php`中的数据库/钉钉企业配置
3. 访问`admin.php?key=你的管理密钥`，点击「同步钉钉用户」，将钉钉企业内用户同步到数据库

### 2. 添加多店铺配置
1. 在`ecommerce_shops`表中手动添加多店铺信息（示例）：
   ```sql
   INSERT INTO ecommerce_shops (shop_name, platform, platform_shop_id, api_config, dingtalk_responsible_ids, dingtalk_group_token, dingtalk_secret)
   VALUES (
       'Shopify美国店',
       'shopify',
       'shop123',
       '{"shop_domain":"your-shop.myshopify.com","access_token":"shpat_xxx","api_version":"2024-07"}',
       'dingtalk_user1,dingtalk_user2', -- 钉钉负责人ID
       'xxxxxxxxx', -- 钉钉群机器人token
       'SEC_xxxxxx' -- 钉钉群机器人加签密钥
   );
   ```
2. 重复添加亚马逊/eBay多店铺，每个店铺配置独立的API参数

### 3. 配置各平台Webhook
每个店铺的Webhook地址格式：
```
# Shopify店铺1
https://你的域名/webhook_receive.php?shop_id=1&platform=shopify

# 亚马逊店铺2
https://你的域名/webhook_receive.php?shop_id=2&platform=amazon

# eBay店铺3
https://你的域名/webhook_receive.php?shop_id=3&platform=ebay
```
- 在各平台卖家后台配置上述URL为Webhook回调地址
- 启用对应「买家消息」事件类型

### 4. 管理钉钉负责人
1. 访问`admin.php?key=你的管理密钥`
2. 点击店铺后的「修改负责人」，选择钉钉用户（可多选）
3. 可选配置钉钉群Token，消息将同时推送到群和个人

### 5. 回复消息
1. 钉钉收到新消息通知后，点击「回复此消息」跳转至回复页面
2. 输入回复内容提交，系统自动调用对应店铺的平台API完成回复
3. 回复状态实时更新至数据库，可在管理后台查看

## 十一、核心优势与扩展建议
### 核心优势
1. **多店铺隔离**：每个店铺独立API配置，数据互不干扰
2. **灵活的负责人配置**：无需改代码，后台一键修改店铺对应的钉钉负责人
3. **多端推送**：支持同时推送到钉钉个人和群，确保消息不遗漏
4. **完整的日志体系**：按日期分文件记录日志，便于问题排查
5. **简易管理后台**：可视化配置，非技术人员也能操作

### 生产环境扩展建议
1. **登录认证**：给管理后台添加钉钉扫码登录，替代简单密钥验证
2. **API重试机制**：回复失败时自动重试3次（间隔5秒）
3. **消息模板**：在回复页面添加常用模板，支持多语言
4. **数据统计**：新增报表页面，统计各店铺/负责人的回复效率
5. **权限细分**：给不同管理员分配不同店铺的管理权限
6. **异常告警**：回复失败/签名验证失败时，推送告警至管理员钉钉

此方案完整支持多平台多店铺接入，钉钉负责人可灵活配置，客服人员无需切换系统，直接在钉钉完成所有消息回复操作，适配跨境电商多店铺运营的核心需求。