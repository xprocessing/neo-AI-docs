# 亚马逊买家消息API（Selling Partner API - Messaging API）

亚马逊卖家与买家通信的官方API，**仅支持卖家向买家发送消息**，不支持直接获取买家消息历史。以下是完整技术对接指南：

## 一、核心接口概览

亚马逊买家消息功能通过**Selling Partner API (SP-API)的Messaging API v1**实现，是卖家中心"联系买家"功能的程序化接口。

**核心功能：**
- 查询指定订单可发送的消息类型（`getMessagingActionsForOrder`）
- 向买家发送预定义类型的消息（如订单确认、发货通知等）
- 支持附件发送（需通过Uploads API上传）

**接口端点：**
```
https://sellingpartnerapi-na.amazon.com/messaging/v1/orders/{orderId}/messagingActions
https://sellingpartnerapi-na.amazon.com/messaging/v1/orders/{orderId}/{messageType}
```

## 二、使用前提与授权

### 1. 开发者账号准备
- 在[Amazon Developer Portal](https://developer.amazonservices.com)注册账号
- 创建SP-API应用，获取Client ID和Client Secret

### 2. 权限要求
必须获取**Buyer Communication**权限（在开发者控制台"Roles"中申请）

### 3. 授权流程（LWA）
```python
# 获取访问令牌示例（Python）
import requests
import base64

def get_access_token():
    url = "https://api.amazon.com/auth/o2/token"
    headers = {
        "Authorization": "Basic " + base64.b64encode(f"{CLIENT_ID}:{CLIENT_SECRET}".encode()).decode(),
        "Content-Type": "application/x-www-form-urlencoded"
    }
    data = {
        "grant_type": "refresh_token",
        "refresh_token": REFRESH_TOKEN,
        "scope": "sellingpartnerapi::messaging"
    }
    response = requests.post(url, headers=headers, data=data)
    return response.json().get("access_token")
```

## 三、核心接口详解

### 1. 获取订单可用消息类型（必选第一步）

**请求：**
```
GET /messaging/v1/orders/{orderId}/messagingActions
Authorization: Bearer <access_token>
```

**响应示例：**
```json
{
  "messagingActions": [
    {
      "action": "createConfirmOrderDetails",
      "description": "Confirm order details with buyer",
      "canIncludeAttachment": false,
      "canIncludeCustomMessage": true
    }
  ]
}
```

**说明：** 必须先调用此接口获取订单支持的消息类型，再调用对应的消息发送接口。

### 2. 发送消息到买家

**请求：**
```
POST /messaging/v1/orders/{orderId}/{messageType}
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "message": {
    "subject": "Order Confirmation",
    "content": "Hello, your order details are confirmed.",
    "contentType": "text/plain"
  },
  "attachment": {
    "fileName": "invoice.pdf",
    "uploadId": "Upload_12345"
  }
}
```

**说明：**
- `messageType`：从第一步获取的action值（如`createConfirmOrderDetails`）
- 消息内容**必须包含订单号**，且使用买家首选语言
- 附件需先通过Uploads API上传获取`uploadId`

## 四、消息类型与限制

### 支持的消息类型（部分）

| 消息类型 | 用途 | 是否支持自定义消息 | 是否支持附件 |
|---------|------|-----------------|------------|
| createConfirmOrderDetails | 确认订单详情 | ✓ | ✗ |
| createConfirmDeliveryDetails | 确认发货详情 | ✓ | ✗ |
| createConfirmServiceDetails | 确认服务详情 | ✓ | ✗ |
| createInvoice | 发送发票 | ✗ | ✓ |
| createUnexpectedProblem | 通知订单问题 | ✓ | ✗ |

### 消息内容限制

- **必须包含订单号**（系统自动添加，API调用时无需手动添加）
- 消息内容**禁止包含**：
  - 买家个人敏感信息（手机号、邮箱等）
  - 外部链接、促销信息
  - 评论操纵相关内容
- 字符限制：整体消息长度≤4000字符
- 仅支持`text/plain`或`text/html`内容类型

### 发送时间限制

- 只能联系**已购买商品的买家**（订单完成后30天内）
- 或**已主动联系过卖家的买家**（不受时间限制）

## 五、完整使用流程（代码示例）

以下是完整的消息发送流程示例（Python）：

```python
import requests
import json
import base64

# 配置信息（替换为你的实际参数）
CLIENT_ID = "your_client_id"
CLIENT_SECRET = "your_client_secret"
REFRESH_TOKEN = "your_refresh_token"
ORDER_ID = "123-4567890-1234567"
MESSAGE_TYPE = "createConfirmOrderDetails"

# 1. 获取访问令牌
def get_access_token():
    url = "https://api.amazon.com/auth/o2/token"
    headers = {
        "Authorization": "Basic " + base64.b64encode(f"{CLIENT_ID}:{CLIENT_SECRET}".encode()).decode(),
        "Content-Type": "application/x-www-form-urlencoded"
    }
    data = {
        "grant_type": "refresh_token",
        "refresh_token": REFRESH_TOKEN,
        "scope": "sellingpartnerapi::messaging"
    }
    response = requests.post(url, headers=headers, data=data)
    return response.json().get("access_token")

# 2. 获取订单可用的消息类型
def get_available_message_types(access_token, order_id):
    url = f"https://sellingpartnerapi-na.amazon.com/messaging/v1/orders/{order_id}/messagingActions"
    headers = {
        "Authorization": f"Bearer {access_token}",
        "Content-Type": "application/json"
    }
    response = requests.get(url, headers=headers)
    return response.json()

# 3. 发送消息到买家
def send_message(access_token, order_id, message_type, subject, content, attachment=None):
    url = f"https://sellingpartnerapi-na.amazon.com/messaging/v1/orders/{order_id}/{message_type}"
    headers = {
        "Authorization": f"Bearer {access_token}",
        "Content-Type": "application/json"
    }
    payload = {
        "message": {
            "subject": subject,
            "content": content,
            "contentType": "text/plain"
        }
    }
    
    if attachment:
        payload["attachment"] = attachment
    
    response = requests.post(url, headers=headers, data=json.dumps(payload))
    return response.json()

# 主流程
if __name__ == "__main__":
    token = get_access_token()
    
    # 验证订单可用的消息类型
    message_actions = get_available_message_types(token, ORDER_ID)
    print("可用的消息类型:")
    for action in message_actions.get("messagingActions", []):
        print(f"- {action['action']}: {action['description']}")
    
    # 如果目标消息类型在可用列表中，则发送消息
    if any(action["action"] == MESSAGE_TYPE for action in message_actions.get("messagingActions", [])):
        # 简单消息示例（不含附件）
        response = send_message(
            token, 
            ORDER_ID, 
            MESSAGE_TYPE, 
            "Order Confirmation", 
            "Hello, your order has been confirmed."
        )
        print("\n消息发送结果:")
        print(json.dumps(response, indent=2))
    else:
        print(f"消息类型 {MESSAGE_TYPE} 对订单 {ORDER_ID} 不可用")
```

## 六、常见错误与处理

| 错误码 | 含义 | 解决方法 |
|--------|------|---------|
| 401 | 未授权/令牌失效 | 重新获取访问令牌 |
| 403 | 权限不足 | 确认已获取Buyer Communication权限 |
| 404 | 资源不存在 | 验证订单ID和消息类型是否正确 |
| 429 | 调用频率受限 | 实现指数退避重试机制 |
| 500 | 服务器错误 | 记录错误并稍后重试 |

## 七、最佳实践

1. **先查询后发送**：每次发送消息前先调用`getMessagingActionsForOrder`，确保消息类型对当前订单有效

2. **消息内容规范**：
   - 使用买家首选语言（API会自动处理）
   - 保持专业简洁，避免营销内容
   - 必须包含订单号（系统自动添加）

3. **附件处理**：
   - 大文件先通过Uploads API上传
   - 确保文件名合规（不含特殊字符）

4. **错误处理**：
   - 实现完整的错误处理和重试机制（特别是429错误）
   - 记录所有API调用和响应，便于排查问题

## 总结

亚马逊Messaging API是卖家与买家沟通的官方渠道，通过它可以实现订单确认、发货通知等自动化消息发送。记住：**此API只支持卖家向买家发送消息，不支持读取买家消息历史**。如需完整的买家消息管理（包括接收和回复），需结合亚马逊卖家中心的站内信功能或第三方解决方案。

**下一步建议：** 在沙盒环境中测试API调用，熟悉消息发送流程后再应用到生产环境。