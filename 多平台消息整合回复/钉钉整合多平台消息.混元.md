æˆ‘æ¥ä¸ºæ‚¨æä¾›ä¸€ä¸ªå®Œæ•´çš„å¤šæ¸ é“ç”µå•†å®¢æœç³»ç»Ÿå®ç°æ–¹æ¡ˆã€‚

## ç³»ç»Ÿæ¶æ„è®¾è®¡

```
ç”µå•†å¹³å° â†’ Webhook â†’ PHPåç«¯ â†’ MySQLå­˜å‚¨ â†’ é’‰é’‰é€šçŸ¥ â†’ å®¢æœå›å¤
    â†“           â†“         â†“          â†“         â†“
 ebay      æ¥æ”¶æ•°æ®   æ¶ˆæ¯å­˜å‚¨   ç¾¤æœºå™¨äºº   é’‰é’‰æ¥å£
 äºšé©¬é€Š     éªŒè¯ç­¾å   çŠ¶æ€ç®¡ç†   è´Ÿè´£äºº    å‘é€å›å¤
 shopify    æ ¼å¼è½¬æ¢   ä¼šè¯ç®¡ç†   åŠ¨æ€é…ç½®   çŠ¶æ€åŒæ­¥
```

## 1. æ•°æ®åº“è®¾è®¡

```sql
-- å¹³å°é…ç½®è¡¨
CREATE TABLE platform_config (
    id INT PRIMARY KEY AUTO_INCREMENT,
    platform VARCHAR(50) NOT NULL COMMENT 'å¹³å°åç§°: ebay, amazon, shopify',
    shop_id VARCHAR(100) NOT NULL COMMENT 'åº—é“ºID',
    shop_name VARCHAR(200) NOT NULL COMMENT 'åº—é“ºåç§°',
    api_key VARCHAR(500) COMMENT 'APIå¯†é’¥',
    webhook_secret VARCHAR(500) COMMENT 'webhookå¯†é’¥',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€: 0ç¦ç”¨,1å¯ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_platform_shop (platform, shop_id)
);

-- é’‰é’‰é…ç½®è¡¨
CREATE TABLE dingtalk_config (
    id INT PRIMARY KEY AUTO_INCREMENT,
    config_name VARCHAR(100) NOT NULL COMMENT 'é…ç½®åç§°',
    webhook_url VARCHAR(500) NOT NULL COMMENT 'é’‰é’‰ç¾¤æœºå™¨äººURL',
    secret VARCHAR(200) COMMENT 'åŠ ç­¾å¯†é’¥',
    responsible_users TEXT COMMENT 'è´Ÿè´£äººç”¨æˆ·IDåˆ—è¡¨,é€—å·åˆ†éš”',
    platform_filters JSON COMMENT 'ç›‘å¬çš„å¹³å°åº—é“ºJSON',
    is_default TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦é»˜è®¤é…ç½®',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€: 0ç¦ç”¨,1å¯ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- æ¶ˆæ¯è®°å½•è¡¨
CREATE TABLE message_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    platform VARCHAR(50) NOT NULL,
    shop_id VARCHAR(100) NOT NULL,
    conversation_id VARCHAR(200) NOT NULL COMMENT 'ä¼šè¯ID',
    message_id VARCHAR(200) NOT NULL COMMENT 'æ¶ˆæ¯ID',
    sender_type ENUM('buyer', 'seller') NOT NULL COMMENT 'å‘é€æ–¹ç±»å‹',
    sender_id VARCHAR(200) COMMENT 'å‘é€è€…ID',
    sender_name VARCHAR(200) COMMENT 'å‘é€è€…åç§°',
    content TEXT COMMENT 'æ¶ˆæ¯å†…å®¹',
    message_time TIMESTAMP NOT NULL COMMENT 'æ¶ˆæ¯æ—¶é—´',
    reply_status TINYINT DEFAULT 0 COMMENT 'å›å¤çŠ¶æ€: 0æœªå›å¤,1å·²å›å¤',
    dingtalk_chat_id VARCHAR(200) COMMENT 'é’‰é’‰ä¼šè¯ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_conversation (conversation_id),
    INDEX idx_platform_shop (platform, shop_id),
    INDEX idx_message_time (message_time),
    UNIQUE KEY uk_message (platform, shop_id, message_id)
);

-- å›å¤è®°å½•è¡¨
CREATE TABLE reply_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    message_id INT NOT NULL COMMENT 'å¯¹åº”æ¶ˆæ¯è®°å½•ID',
    reply_content TEXT NOT NULL COMMENT 'å›å¤å†…å®¹',
    reply_user_id VARCHAR(100) COMMENT 'å›å¤äººID',
    reply_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (message_id) REFERENCES message_records(id)
);
```

## 2. æ ¸å¿ƒé…ç½®æ–‡ä»¶

**config/database.php**
```php
<?php
return [
    'host' => 'localhost',
    'dbname' => 'ec_customer_service',
    'username' => 'root',
    'password' => '',
    'charset' => 'utf8mb4'
];
```

**config/platform.php**
```php
<?php
return [
    'ebay' => [
        'webhook_path' => '/webhook/ebay',
        'verify_token' => 'your_ebay_verify_token'
    ],
    'amazon' => [
        'webhook_path' => '/webhook/amazon',
        'verify_token' => 'your_amazon_verify_token'
    ],
    'shopify' => [
        'webhook_path' => '/webhook/shopify',
        'api_key' => 'your_shopify_api_key'
    ]
];
```

## 3. æ•°æ®åº“è¿æ¥ç±»

**includes/Database.php**
```php
<?php
class Database {
    private $pdo;
    
    public function __construct($config) {
        try {
            $dsn = "mysql:host={$config['host']};dbname={$config['dbname']};charset={$config['charset']}";
            $this->pdo = new PDO($dsn, $config['username'], $config['password']);
            $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        } catch (PDOException $e) {
            throw new Exception("æ•°æ®åº“è¿æ¥å¤±è´¥: " . $e->getMessage());
        }
    }
    
    public function getConnection() {
        return $this->pdo;
    }
}
```

## 4. å¹³å°é…ç½®ç®¡ç†ç±»

**includes/PlatformManager.php**
```php
<?php
class PlatformManager {
    private $db;
    
    public function __construct($database) {
        $this->db = $database;
    }
    
    // è·å–å¯ç”¨çš„å¹³å°é…ç½®
    public function getActivePlatforms() {
        $stmt = $this->db->prepare("SELECT * FROM platform_config WHERE status = 1");
        $stmt->execute();
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
    
    // æ ¹æ®å¹³å°å’Œåº—é“ºIDè·å–é…ç½®
    public function getPlatformConfig($platform, $shopId) {
        $stmt = $this->db->prepare(
            "SELECT * FROM platform_config WHERE platform = ? AND shop_id = ? AND status = 1"
        );
        $stmt->execute([$platform, $shopId]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }
    
    // æ·»åŠ æˆ–æ›´æ–°å¹³å°é…ç½®
    public function savePlatformConfig($data) {
        if (isset($data['id']) && $data['id']) {
            $sql = "UPDATE platform_config SET platform=?, shop_id=?, shop_name=?, 
                    api_key=?, webhook_secret=?, status=? WHERE id=?";
            $stmt = $this->db->prepare($sql);
            return $stmt->execute([
                $data['platform'], $data['shop_id'], $data['shop_name'],
                $data['api_key'], $data['webhook_secret'], $data['status'], $data['id']
            ]);
        } else {
            $sql = "INSERT INTO platform_config (platform, shop_id, shop_name, api_key, webhook_secret, status) 
                    VALUES (?, ?, ?, ?, ?, ?)";
            $stmt = $this->db->prepare($sql);
            return $stmt->execute([
                $data['platform'], $data['shop_id'], $data['shop_name'],
                $data['api_key'], $data['webhook_secret'], $data['status']
            ]);
        }
    }
}
```

## 5. é’‰é’‰ç®¡ç†ç±»

**includes/DingTalkManager.php**
```php
<?php
class DingTalkManager {
    private $db;
    
    public function __construct($database) {
        $this->db = $database;
    }
    
    // è·å–æ‰€æœ‰å¯ç”¨çš„é’‰é’‰é…ç½®
    public function getActiveDingTalkConfigs() {
        $stmt = $this->db->prepare("SELECT * FROM dingtalk_config WHERE status = 1 ORDER BY is_default DESC");
        $stmt->execute();
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
    
    // æ ¹æ®IDè·å–é’‰é’‰é…ç½®
    public function getDingTalkConfig($id) {
        $stmt = $this->db->prepare("SELECT * FROM dingtalk_config WHERE id = ? AND status = 1");
        $stmt->execute([$id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }
    
    // ä¿å­˜é’‰é’‰é…ç½®
    public function saveDingTalkConfig($data) {
        if (isset($data['id']) && $data['id']) {
            $sql = "UPDATE dingtalk_config SET config_name=?, webhook_url=?, secret=?, 
                    responsible_users=?, platform_filters=?, is_default=?, status=? WHERE id=?";
            $stmt = $this->db->prepare($sql);
            return $stmt->execute([
                $data['config_name'], $data['webhook_url'], $data['secret'],
                $data['responsible_users'], json_encode($data['platform_filters']),
                $data['is_default'], $data['status'], $data['id']
            ]);
        } else {
            $sql = "INSERT INTO dingtalk_config (config_name, webhook_url, secret, responsible_users, 
                    platform_filters, is_default, status) VALUES (?, ?, ?, ?, ?, ?, ?)";
            $stmt = $this->db->prepare($sql);
            return $stmt->execute([
                $data['config_name'], $data['webhook_url'], $data['secret'],
                $data['responsible_users'], json_encode($data['platform_filters']),
                $data['is_default'], $data['status']
            ]);
        }
    }
    
    // è·å–åŒ¹é…çš„é’‰é’‰é…ç½®
    public function getMatchingConfigs($platform, $shopId) {
        $configs = $this->getActiveDingTalkConfigs();
        $matched = [];
        
        foreach ($configs as $config) {
            $filters = json_decode($config['platform_filters'], true);
            if (!$filters || empty($filters)) {
                // å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡æ»¤å™¨ï¼Œé»˜è®¤åŒ¹é…æ‰€æœ‰
                if ($config['is_default']) {
                    $matched[] = $config;
                }
                continue;
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…å¹³å°å’Œåº—é“º
            foreach ($filters as $filter) {
                if ($filter['platform'] === $platform && $filter['shop_id'] === $shopId) {
                    $matched[] = $config;
                    break;
                }
            }
        }
        
        // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ç‰¹å®šé…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
        if (empty($matched)) {
            foreach ($configs as $config) {
                if ($config['is_default']) {
                    $matched[] = $config;
                    break;
                }
            }
        }
        
        return $matched;
    }
    
    // å‘é€æ¶ˆæ¯åˆ°é’‰é’‰
    public function sendToDingTalk($config, $message) {
        $webhookUrl = $config['webhook_url'];
        $secret = $config['secret'];
        
        // å¦‚æœæœ‰åŠ ç­¾å¯†é’¥ï¼Œéœ€è¦ç”Ÿæˆç­¾å
        if ($secret) {
            $timestamp = round(microtime(true) * 1000);
            $sign = urlencode(base64_encode(hash_hmac('sha256', $timestamp . "\n" . $secret, $secret, true)));
            $webhookUrl .= "&timestamp=$timestamp&sign=$sign";
        }
        
        $data = [
            "msgtype" => "markdown",
            "markdown" => [
                "title" => "æ–°å®¢æˆ·æ¶ˆæ¯",
                "text" => $message
            ],
            "at" => [
                "atMobiles" => [],
                "isAtAll" => false
            ]
        ];
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $webhookUrl);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        return $httpCode === 200;
    }
}
```

## 6. æ¶ˆæ¯å¤„ç†ç±»

**includes/MessageProcessor.php**
```php
<?php
class MessageProcessor {
    private $db;
    private $platformManager;
    private $dingTalkManager;
    
    public function __construct($database, $platformManager, $dingTalkManager) {
        $this->db = $database;
        $this->platformManager = $platformManager;
        $this->dingTalkManager = $dingTalkManager;
    }
    
    // å¤„ç†ebay webhook
    public function handleEbayWebhook($rawData, $headers) {
        // éªŒè¯ebay webhookç­¾å
        if (!$this->verifyEbaySignature($rawData, $headers)) {
            throw new Exception("eBayç­¾åéªŒè¯å¤±è´¥");
        }
        
        $data = json_decode($rawData, true);
        $this->processMessage('ebay', $data);
    }
    
    // å¤„ç†amazon webhook
    public function handleAmazonWebhook($rawData, $headers) {
        // éªŒè¯amazonç­¾å
        if (!$this->verifyAmazonSignature($rawData, $headers)) {
            throw new Exception("Amazonç­¾åéªŒè¯å¤±è´¥");
        }
        
        $data = json_decode($rawData, true);
        $this->processMessage('amazon', $data);
    }
    
    // å¤„ç†shopify webhook
    public function handleShopifyWebhook($rawData, $headers) {
        // éªŒè¯shopify HMAC
        if (!$this->verifyShopifyHMAC($rawData, $headers)) {
            throw new Exception("Shopify HMACéªŒè¯å¤±è´¥");
        }
        
        $data = json_decode($rawData, true);
        $this->processMessage('shopify', $data);
    }
    
    // ç»Ÿä¸€æ¶ˆæ¯å¤„ç†
    private function processMessage($platform, $data) {
        // æ ¹æ®ä¸åŒå¹³å°è§£ææ¶ˆæ¯
        $messageInfo = $this->parseMessageByPlatform($platform, $data);
        
        if (!$messageInfo) {
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ¶ˆæ¯
        if ($this->isMessageExists($platform, $messageInfo['shop_id'], $messageInfo['message_id'])) {
            return false;
        }
        
        // ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
        $messageId = $this->saveMessage($platform, $messageInfo);
        
        // å‘é€åˆ°é’‰é’‰
        $this->sendToDingTalk($platform, $messageInfo, $messageId);
        
        return $messageId;
    }
    
    // æ ¹æ®å¹³å°è§£ææ¶ˆæ¯æ ¼å¼
    private function parseMessageByPlatform($platform, $data) {
        switch ($platform) {
            case 'ebay':
                return $this->parseEbayMessage($data);
            case 'amazon':
                return $this->parseAmazonMessage($data);
            case 'shopify':
                return $this->parseShopifyMessage($data);
            default:
                return false;
        }
    }
    
    // è§£æeBayæ¶ˆæ¯
    private function parseEbayMessage($data) {
        // æ ¹æ®eBay Messages APIæ ¼å¼è§£æ
        return [
            'shop_id' => $data['recipient']['userId']['value'] ?? '',
            'conversation_id' => $data['conversationId'] ?? '',
            'message_id' => $data['messageId'] ?? '',
            'sender_type' => 'buyer',
            'sender_id' => $data['sender']['userId']['value'] ?? '',
            'sender_name' => $data['sender']['name'] ?? '',
            'content' => $data['message']['text'] ?? '',
            'message_time' => date('Y-m-d H:i:s', strtotime($data['messageDate']['value'] ?? ''))
        ];
    }
    
    // è§£æAmazonæ¶ˆæ¯
    private function parseAmazonMessage($data) {
        // æ ¹æ®Amazon SP-API Messagesæ ¼å¼è§£æ
        return [
            'shop_id' => $data['marketplaceId'] ?? '',
            'conversation_id' => $data['threadId'] ?? '',
            'message_id' => $data['messageId'] ?? '',
            'sender_type' => $data['sender'] === 'BUYER' ? 'buyer' : 'seller',
            'sender_id' => $data['senderId'] ?? '',
            'sender_name' => $data['senderName'] ?? '',
            'content' => $data['content'] ?? '',
            'message_time' => date('Y-m-d H:i:s', strtotime($data['createdAt'] ?? ''))
        ];
    }
    
    // è§£æShopifyæ¶ˆæ¯
    private function parseShopifyMessage($data) {
        // æ ¹æ®Shopify Admin API Customer Messagesæ ¼å¼è§£æ
        return [
            'shop_id' => $data['shop_domain'] ?? '',
            'conversation_id' => $data['conversation_id'] ?? '',
            'message_id' => $data['id'] ?? '',
            'sender_type' => $data['author']['type'] === 'customer' ? 'buyer' : 'seller',
            'sender_id' => $data['author']['id'] ?? '',
            'sender_name' => $data['author']['display_name'] ?? '',
            'content' => strip_tags($data['body'] ?? ''),
            'message_time' => date('Y-m-d H:i:s', strtotime($data['created_at'] ?? ''))
        ];
    }
    
    // éªŒè¯eBayç­¾å
    private function verifyEbaySignature($rawData, $headers) {
        // å®ç°eBay webhookç­¾åéªŒè¯é€»è¾‘
        $signature = $headers['X-EBAY-SIGNATURE'] ?? '';
        // è¿™é‡Œéœ€è¦æ ¹æ®eBayçš„å…·ä½“ç­¾åç®—æ³•å®ç°
        return !empty($signature); // ç®€åŒ–ç¤ºä¾‹
    }
    
    // éªŒè¯Amazonç­¾å
    private function verifyAmazonSignature($rawData, $headers) {
        // å®ç°Amazonç­¾åéªŒè¯é€»è¾‘
        $signature = $headers['x-amz-sns-message-signature'] ?? '';
        // è¿™é‡Œéœ€è¦æ ¹æ®Amazonçš„å…·ä½“ç­¾åç®—æ³•å®ç°
        return !empty($signature); // ç®€åŒ–ç¤ºä¾‹
    }
    
    // éªŒè¯Shopify HMAC
    private function verifyShopifyHMAC($rawData, $headers) {
        $hmacHeader = $headers['X-Shopify-Hmac-Sha256'] ?? '';
        $secret = 'your_shopify_webhook_secret'; // ä»é…ç½®è¯»å–
        
        $calculatedHmac = base64_encode(hash_hmac('sha256', $rawData, $secret, true));
        return hash_equals($hmacHeader, $calculatedHmac);
    }
    
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨
    private function isMessageExists($platform, $shopId, $messageId) {
        $stmt = $this->db->prepare(
            "SELECT id FROM message_records WHERE platform = ? AND shop_id = ? AND message_id = ?"
        );
        $stmt->execute([$platform, $shopId, $messageId]);
        return $stmt->fetch() !== false;
    }
    
    // ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    private function saveMessage($platform, $messageInfo) {
        $stmt = $this->db->prepare(
            "INSERT INTO message_records (platform, shop_id, conversation_id, message_id, 
             sender_type, sender_id, sender_name, content, message_time) 
             VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)"
        );
        $stmt->execute([
            $platform, $messageInfo['shop_id'], $messageInfo['conversation_id'],
            $messageInfo['message_id'], $messageInfo['sender_type'], $messageInfo['sender_id'],
            $messageInfo['sender_name'], $messageInfo['content'], $messageInfo['message_time']
        ]);
        return $this->db->lastInsertId();
    }
    
    // å‘é€æ¶ˆæ¯åˆ°é’‰é’‰
    private function sendToDingTalk($platform, $messageInfo, $messageId) {
        $shopConfig = $this->platformManager->getPlatformConfig($platform, $messageInfo['shop_id']);
        $shopName = $shopConfig ? $shopConfig['shop_name'] : $messageInfo['shop_id'];
        
        // æ„å»ºé’‰é’‰æ¶ˆæ¯
        $message = "### ğŸ›ï¸ æ–°å®¢æˆ·æ¶ˆæ¯\n\n";
        $message .= "**å¹³å°**: " . strtoupper($platform) . "\n";
        $message .= "**åº—é“º**: {$shopName}\n";
        $message .= "**ä¹°å®¶**: {$messageInfo['sender_name']}\n";
        $message .= "**æ—¶é—´**: {$messageInfo['message_time']}\n";
        $message .= "**å†…å®¹**: {$messageInfo['content']}\n\n";
        $message .= "[ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…](https://your-domain.com/messages/{$messageId})";
        
        // è·å–åŒ¹é…çš„é’‰é’‰é…ç½®å¹¶å‘é€
        $dingTalkConfigs = $this->dingTalkManager->getMatchingConfigs($platform, $messageInfo['shop_id']);
        
        foreach ($dingTalkConfigs as $config) {
            $this->dingTalkManager->sendToDingTalk($config, $message);
        }
    }
    
    // å›å¤æ¶ˆæ¯
    public function replyToMessage($messageId, $replyContent, $replyUserId) {
        // è·å–åŸå§‹æ¶ˆæ¯ä¿¡æ¯
        $stmt = $this->db->prepare(
            "SELECT * FROM message_records WHERE id = ?"
        );
        $stmt->execute([$messageId]);
        $originalMessage = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$originalMessage) {
            throw new Exception("æ¶ˆæ¯ä¸å­˜åœ¨");
        }
        
        // ä¿å­˜å›å¤è®°å½•
        $stmt = $this->db->prepare(
            "INSERT INTO reply_records (message_id, reply_content, reply_user_id) VALUES (?, ?, ?)"
        );
        $stmt->execute([$messageId, $replyContent, $replyUserId]);
        
        // æ›´æ–°æ¶ˆæ¯å›å¤çŠ¶æ€
        $stmt = $this->db->prepare(
            "UPDATE message_records SET reply_status = 1 WHERE id = ?"
        );
        $stmt->execute([$messageId]);
        
        // è°ƒç”¨å¹³å°APIå‘é€å›å¤ï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®å„å¹³å°APIå®ç°ï¼‰
        $this->sendReplyToPlatform($originalMessage, $replyContent);
        
        return true;
    }
    
    // å‘é€å›å¤åˆ°å¹³å°
    private function sendReplyToPlatform($originalMessage, $replyContent) {
        switch ($originalMessage['platform']) {
            case 'ebay':
                $this->sendReplyToEbay($originalMessage, $replyContent);
                break;
            case 'amazon':
                $this->sendReplyToAmazon($originalMessage, $replyContent);
                break;
            case 'shopify':
                $this->sendReplyToShopify($originalMessage, $replyContent);
                break;
        }
    }
    
    // å‘é€å›å¤åˆ°eBayï¼ˆç¤ºä¾‹ï¼‰
    private function sendReplyToEbay($originalMessage, $replyContent) {
        $config = $this->platformManager->getPlatformConfig('ebay', $originalMessage['shop_id']);
        if (!$config) {
            throw new Exception("æœªæ‰¾åˆ°eBayåº—é“ºé…ç½®");
        }
        
        // è°ƒç”¨eBay Messages APIå‘é€å›å¤
        // è¿™é‡Œéœ€è¦å®ç°å…·ä½“çš„eBay APIè°ƒç”¨é€»è¾‘
    }
    
    // å‘é€å›å¤åˆ°Amazonï¼ˆç¤ºä¾‹ï¼‰
    private function sendReplyToAmazon($originalMessage, $replyContent) {
        $config = $this->platformManager->getPlatformConfig('amazon', $originalMessage['shop_id']);
        if (!$config) {
            throw new Exception("æœªæ‰¾åˆ°Amazonåº—é“ºé…ç½®");
        }
        
        // è°ƒç”¨Amazon SP-APIå‘é€å›å¤
        // è¿™é‡Œéœ€è¦å®ç°å…·ä½“çš„Amazon APIè°ƒç”¨é€»è¾‘
    }
    
    // å‘é€å›å¤åˆ°Shopifyï¼ˆç¤ºä¾‹ï¼‰
    private function sendReplyToShopify($originalMessage, $replyContent) {
        $config = $this->platformManager->getPlatformConfig('shopify', $originalMessage['shop_id']);
        if (!$config) {
            throw new Exception("æœªæ‰¾åˆ°Shopifyåº—é“ºé…ç½®");
        }
        
        // è°ƒç”¨Shopify Admin APIå‘é€å›å¤
        // è¿™é‡Œéœ€è¦å®ç°å…·ä½“çš„Shopify APIè°ƒç”¨é€»è¾‘
    }
}
```

## 7. Webhookæ¥å£æ–‡ä»¶

**webhook/ebay.php**
```php
<?php
require_once '../includes/autoload.php';

header('Content-Type: application/json');

try {
    $rawData = file_get_contents('php://input');
    $headers = getallheaders();
    
    $database = new Database(require '../config/database.php');
    $platformManager = new PlatformManager($database->getConnection());
    $dingTalkManager = new DingTalkManager($database->getConnection());
    $messageProcessor = new MessageProcessor($database->getConnection(), $platformManager, $dingTalkManager);
    
    $messageProcessor->handleEbayWebhook($rawData, $headers);
    
    echo json_encode(['success' => true]);
    
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode(['error' => $e->getMessage()]);
}
```

**webhook/amazon.php**
```php
<?php
require_once '../includes/autoload.php';

header('Content-Type: application/json');

try {
    $rawData = file_get_contents('php://input');
    $headers = getallheaders();
    
    $database = new Database(require '../config/database.php');
    $platformManager = new PlatformManager($database->getConnection());
    $dingTalkManager = new DingTalkManager($database->getConnection());
    $messageProcessor = new MessageProcessor($database->getConnection(), $platformManager, $dingTalkManager);
    
    $messageProcessor->handleAmazonWebhook($rawData, $headers);
    
    echo json_encode(['success' => true]);
    
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode(['error' => $e->getMessage()]);
}
```

**webhook/shopify.php**
```php
<?php
require_once '../includes/autoload.php';

header('Content-Type: application/json');

try {
    $rawData = file_get_contents('php://input');
    $headers = getallheaders();
    
    $database = new Database(require '../config/database.php');
    $platformManager = new PlatformManager($database->getConnection());
    $dingTalkManager = new DingTalkManager($database->getConnection());
    $messageProcessor = new MessageProcessor($database->getConnection(), $platformManager, $dingTalkManager);
    
    $messageProcessor->handleShopifyWebhook($rawData, $headers);
    
    echo json_encode(['success' => true]);
    
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode(['error' => $e->getMessage()]);
}
```

## 8. ç®¡ç†åå°é¡µé¢

**admin/config.php**
```php
<?php
session_start();
if (!isset($_SESSION['admin_logged_in'])) {
    header('Location: login.php');
    exit;
}

require_once '../includes/autoload.php';

$database = new Database(require '../config/database.php');
$platformManager = new PlatformManager($database->getConnection());
$dingTalkManager = new DingTalkManager($database->getConnection());

// å¤„ç†è¡¨å•æäº¤
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['action'])) {
        switch ($_POST['action']) {
            case 'save_platform':
                $result = $platformManager->savePlatformConfig($_POST);
                $message = $result ? 'å¹³å°é…ç½®ä¿å­˜æˆåŠŸ' : 'ä¿å­˜å¤±è´¥';
                break;
            case 'save_dingtalk':
                $result = $dingTalkManager->saveDingTalkConfig($_POST);
                $message = $result ? 'é’‰é’‰é…ç½®ä¿å­˜æˆåŠŸ' : 'ä¿å­˜å¤±è´¥';
                break;
        }
    }
}

// è·å–æ•°æ®
$platforms = $platformManager->getActivePlatforms();
$dingTalkConfigs = $dingTalkManager->getActiveDingTalkConfigs();
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å®¢æœç³»ç»Ÿé…ç½®</title>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .table th { background: #f8f9fa; }
        .tabs { margin-bottom: 20px; }
        .tab-button { background: #f8f9fa; border: none; padding: 10px 20px; cursor: pointer; }
        .tab-button.active { background: #007cba; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç”µå•†å®¢æœç³»ç»Ÿé…ç½®</h1>
        
        <?php if (isset($message)): ?>
            <div class="message success"><?php echo $message; ?></div>
        <?php endif; ?>
        
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('platform')">å¹³å°é…ç½®</button>
            <button class="tab-button" onclick="showTab('dingtalk')">é’‰é’‰é…ç½®</button>
            <button class="tab-button" onclick="showTab('messages')">æ¶ˆæ¯ç®¡ç†</button>
        </div>
        
        <!-- å¹³å°é…ç½® -->
        <div id="platform-tab" class="tab-content active">
            <div class="section">
                <h2>æ·»åŠ /ç¼–è¾‘å¹³å°é…ç½®</h2>
                <form method="post">
                    <input type="hidden" name="action" value="save_platform">
                    <input type="hidden" name="id" value="">
                    
                    <div class="form-group">
                        <label>å¹³å°</label>
                        <select name="platform" required>
                            <option value="ebay">eBay</option>
                            <option value="amazon">Amazon</option>
                            <option value="shopify">Shopify</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>åº—é“ºID</label>
                        <input type="text" name="shop_id" required>
                    </div>
                    
                    <div class="form-group">
                        <label>åº—é“ºåç§°</label>
                        <input type="text" name="shop_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>APIå¯†é’¥</label>
                        <textarea name="api_key" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Webhookå¯†é’¥</label>
                        <input type="text" name="webhook_secret">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="status" value="1" checked> å¯ç”¨
                        </label>
                    </div>
                    
                    <button type="submit">ä¿å­˜é…ç½®</button>
                </form>
            </div>
            
            <div class="section">
                <h2>å¹³å°é…ç½®åˆ—è¡¨</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>å¹³å°</th>
                            <th>åº—é“ºID</th>
                            <th>åº—é“ºåç§°</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($platforms as $platform): ?>
                        <tr>
                            <td><?php echo strtoupper($platform['platform']); ?></td>
                            <td><?php echo htmlspecialchars($platform['shop_id']); ?></td>
                            <td><?php echo htmlspecialchars($platform['shop_name']); ?></td>
                            <td><?php echo $platform['status'] ? 'å¯ç”¨' : 'ç¦ç”¨'; ?></td>
                            <td>
                                <button onclick="editPlatform(<?php echo htmlspecialchars(json_encode($platform)); ?>)">ç¼–è¾‘</button>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- é’‰é’‰é…ç½® -->
        <div id="dingtalk-tab" class="tab-content">
            <div class="section">
                <h2>æ·»åŠ /ç¼–è¾‘é’‰é’‰é…ç½®</h2>
                <form method="post">
                    <input type="hidden" name="action" value="save_dingtalk">
                    <input type="hidden" name="id" value="">
                    
                    <div class="form-group">
                        <label>é…ç½®åç§°</label>
                        <input type="text" name="config_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Webhook URL</label>
                        <input type="url" name="webhook_url" required>
                    </div>
                    
                    <div class="form-group">
                        <label>åŠ ç­¾å¯†é’¥</label>
                        <input type="text" name="secret">
                    </div>
                    
                    <div class="form-group">
                        <label>è´Ÿè´£äººç”¨æˆ·IDï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <input type="text" name="responsible_users" placeholder="user1,user2,user3">
                    </div>
                    
                    <div class="form-group">
                        <label>ç›‘å¬çš„å¹³å°åº—é“º</label>
                        <div id="platform-filters">
                            <!-- åŠ¨æ€æ·»åŠ å¹³å°è¿‡æ»¤å™¨ -->
                        </div>
                        <button type="button" onclick="addPlatformFilter()">æ·»åŠ å¹³å°è¿‡æ»¤</button>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="is_default" value="1"> è®¾ä¸ºé»˜è®¤é…ç½®
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="status" value="1" checked> å¯ç”¨
                        </label>
                    </div>
                    
                    <button type="submit">ä¿å­˜é…ç½®</button>
                </form>
            </div>
            
            <div class="section">
                <h2>é’‰é’‰é…ç½®åˆ—è¡¨</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>é…ç½®åç§°</th>
                            <th>è´Ÿè´£äºº</th>
                            <th>é»˜è®¤</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($dingTalkConfigs as $config): ?>
                        <tr>
                            <td><?php echo htmlspecialchars($config['config_name']); ?></td>
                            <td><?php echo htmlspecialchars($config['responsible_users']); ?></td>
                            <td><?php echo $config['is_default'] ? 'æ˜¯' : 'å¦'; ?></td>
                            <td><?php echo $config['status'] ? 'å¯ç”¨' : 'ç¦ç”¨'; ?></td>
                            <td>
                                <button onclick="editDingTalk(<?php echo htmlspecialchars(json_encode($config)); ?>)">ç¼–è¾‘</button>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        function editPlatform(data) {
            const form = document.querySelector('#platform-tab form');
            form.id.value = data.id;
            form.platform.value = data.platform;
            form.shop_id.value = data.shop_id;
            form.shop_name.value = data.shop_name;
            form.api_key.value = data.api_key;
            form.webhook_secret.value = data.webhook_secret;
            form.status.checked = data.status == 1;
        }
        
        function editDingTalk(data) {
            const form = document.querySelector('#dingtalk-tab form');
            form.id.value = data.id;
            form.config_name.value = data.config_name;
            form.webhook_url.value = data.webhook_url;
            form.secret.value = data.secret;
            form.responsible_users.value = data.responsible_users;
            form.is_default.checked = data.is_default == 1;
            form.status.checked = data.status == 1;
        }
        
        let filterIndex = 0;
        function addPlatformFilter() {
            const container = document.getElementById('platform-filters');
            const div = document.createElement('div');
            div.style.marginBottom = '10px';
            div.innerHTML = `
                <select name="platform_filters[${filterIndex}][platform]" style="width: 150px; margin-right: 10px;">
                    <option value="ebay">eBay</option>
                    <option value="amazon">Amazon</option>
                    <option value="shopify">Shopify</option>
                </select>
                <input type="text" name="platform_filters[${filterIndex}][shop_id]" placeholder="åº—é“ºID" style="width: 200px;">
                <button type="button" onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            container.appendChild(div);
            filterIndex++;
        }
    </script>
</body>
</html>
```

## 9. è‡ªåŠ¨åŠ è½½æ–‡ä»¶

**includes/autoload.php**
```php
<?php
spl_autoload_register(function ($class_name) {
    $class_path = __DIR__ . '/' . $class_name . '.php';
    if (file_exists($class_path)) {
        require_once $class_path;
    }
});
```

## 10. éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒè¦æ±‚
- PHP 7.4+
- MySQL 5.7+
- cURLæ‰©å±•
- JSONæ‰©å±•

### å®‰è£…æ­¥éª¤

1. **åˆ›å»ºæ•°æ®åº“å’Œè¡¨ç»“æ„**
```bash
mysql -u root -p < database.sql
```

2. **é…ç½®webhook URLs**
   - eBay: `https://your-domain.com/webhook/ebay`
   - Amazon: `https://your-domain.com/webhook/amazon`  
   - Shopify: `https://your-domain.com/webhook/shopify`

3. **é…ç½®å„å¹³å°webhook**
   - åœ¨eBayå¼€å‘è€…æ§åˆ¶å°é…ç½®webhook URLå’ŒéªŒè¯token
   - åœ¨Amazon SNSä¸­é…ç½®è®¢é˜…ç«¯ç‚¹
   - åœ¨Shopify Adminä¸­é…ç½®webhook

4. **è®¾ç½®é’‰é’‰ç¾¤æœºå™¨äºº**
   - åˆ›å»ºé’‰é’‰ç¾¤æœºå™¨äººï¼Œè·å–webhook URL
   - å¦‚æœ‰éœ€è¦ï¼Œé…ç½®åŠ ç­¾å¯†é’¥

5. **é…ç½®å¹³å°å‚æ•°**
   - åœ¨ç®¡ç†åå°æ·»åŠ å„å¹³å°åº—é“ºé…ç½®
   - é…ç½®é’‰é’‰è´Ÿè´£äººå’Œç›‘å¬è§„åˆ™

### å®‰å…¨å»ºè®®

1. ä½¿ç”¨HTTPSä¿æŠ¤webhook endpoints
2. å®šæœŸæ›´æ¢webhook secretså’ŒAPI keys
3. å®æ–½IPç™½åå•é™åˆ¶ï¼ˆå¦‚æœå¯èƒ½ï¼‰
4. è®°å½•æ‰€æœ‰webhookè¯·æ±‚ç”¨äºå®¡è®¡
5. è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™

è¿™ä¸ªç³»ç»Ÿæä¾›äº†å®Œæ•´çš„å¤šæ¸ é“ç”µå•†å®¢æœè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒçµæ´»çš„é…ç½®ç®¡ç†å’Œæ–¹ä¾¿çš„é’‰é’‰è´Ÿè´£äººè°ƒæ•´ã€‚æ‚¨å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚è¿›ä¸€æ­¥å®Œå–„å„å¹³å°çš„APIé›†æˆç»†èŠ‚ã€‚