# 城市房产小程序架构规划（Java技术栈+前后分离）
## 一、架构设计核心原则
基于**前后分离+微服务架构**，遵循「高可用、高扩展、高性能、高安全」原则，适配房产小程序的核心场景（房源浏览/发布、预约看房、数据管理等），兼顾开发效率与运维成本。

## 二、需求核心梳理
### 1. 角色划分
- **C端用户**：普通购房者/租房者（房源浏览、筛选、收藏、预约看房、用户中心）；
- **B端商家**：房产中介/房东（房源发布、订单管理、客户管理、数据统计）；
- **平台管理员**：系统运营（房源审核、用户管理、权限配置、数据监控）。

### 2. 核心非功能需求
- 高并发：看房高峰期（如节假日）接口QPS需支撑1000+；
- 高性能：房源搜索响应时间<300ms，列表加载<500ms；
- 可扩展：支持后续新增租赁/二手房/新房等业务模块；
- 数据安全：用户隐私（手机号/身份证）、房源数据脱敏与加密；
- 兼容性：适配微信小程序主流版本，支持跨端（支付宝/抖音）扩展。

## 三、整体架构分层
采用「前端层→网关层→应用服务层→中间件层→数据层→基础设施层」的分层架构，整体如下：

```
┌─────────────────┐
│ 前端层（小程序/PC） │
└────────┬────────┘
         │
┌────────▼────────┐
│ 网关层（Gateway） │
└────────┬────────┘
         │
┌────────▼────────┐
│ 应用服务层（微服务） │
│ ┌─────────────┐ │
│ │ 用户服务    │ │
│ │ 房源服务    │ │
│ │ 订单服务    │ │
│ │ 搜索服务    │ │
│ │ 消息服务    │ │
│ │ 统计服务    │ │
│ │ 管理服务    │ │
│ └─────────────┘ │
└────────┬────────┘
         │
┌────────▼────────┐
│ 中间件层        │
│ 注册中心/配置中心│
│ 缓存/消息队列   │
│ 搜索引擎/对象存储│
└────────┬────────┘
         │
┌────────▼────────┐
│ 数据层          │
│ MySQL（主从）   │
│ Elasticsearch   │
└────────┬────────┘
         │
┌────────▼────────┐
│ 基础设施层      │
│ Docker/K8s      │
│ 监控/日志/CI/CD │
└─────────────────┘
```

## 四、技术栈选型
### 1. 前端技术栈（前后分离核心）
| 场景                | 技术选型                          | 说明                     |
|---------------------|-----------------------------------|--------------------------|
| 小程序端（C/B端）| Uniapp + Vue3 + Pinia             | 跨端兼容（微信/支付宝），状态管理 |
| 管理后台（PC端）| Vue3 + Element Plus + Axios       | 后台管理系统，组件化开发       |
| 通用能力            | 微信小程序原生API、OSS SDK        | 支付、订阅消息、文件上传       |
| 优化                | 图片懒加载、小程序分包、请求缓存  | 提升小程序加载速度             |

### 2. 后端技术栈（Java核心）
| 分层        | 技术选型                                  | 说明                                   |
|-------------|-------------------------------------------|----------------------------------------|
| 基础框架    | Spring Boot 3.x + Spring Cloud Alibaba    | 微服务核心框架，阿里生态适配小程序场景 |
| 网关        | Spring Cloud Gateway                      | 统一入口、鉴权、限流、跨域             |
| 服务治理    | Nacos（注册+配置中心）+ Sentinel（熔断）  | 服务注册发现、动态配置、熔断降级       |
| 远程调用    | OpenFeign                                 | 微服务间HTTP调用简化                   |
| ORM         | MyBatis-Plus + Dynamic-Datasource         | 数据库操作、多数据源（主从）           |
| 认证授权    | Spring Security + JWT                     | 接口鉴权、RBAC权限模型                 |
| 缓存        | Redis 7.x（集群）                         | 热点数据缓存、Token存储、防击穿       |
| 消息队列    | RocketMQ                                  | 异步处理（审核通知、短信、ES同步）     |
| 搜索引擎    | Elasticsearch 8.x + IK分词器             | 房源复杂筛选、模糊搜索（小区/户型）    |
| 对象存储    | 阿里云OSS/腾讯云COS                      | 房源图片/视频存储，CDN加速             |
| 分布式事务  | Seata（可选）                             | 跨服务事务（如订单+支付）              |
| 数据库      | MySQL 8.x（主从复制+分库分表）            | 核心数据存储，读分离提升性能           |

### 3. 基础设施技术栈
| 场景        | 技术选型                          | 说明                     |
|-------------|-----------------------------------|--------------------------|
| 容器化      | Docker + Kubernetes（K8s）       | 服务编排、自动扩缩容     |
| 监控        | Prometheus + Grafana + AlertManager | 指标监控、异常告警       |
| 日志        | ELK（Elasticsearch+Logstash+Kibana） | 日志收集、检索、分析     |
| CI/CD       | Jenkins + GitLab                  | 自动化构建、部署         |

## 五、核心模块设计
### 1. 微服务拆分（按领域边界）
| 服务名称       | 核心职责                                                                 |
|----------------|--------------------------------------------------------------------------|
| 基础服务（Common） | 公共工具类、统一返回体、异常处理、枚举、跨服务常量                       |
| 用户服务（User）| 用户注册/登录、实名认证、权限管理、用户信息维护                         |
| 房源服务（House）| 房源发布/编辑/上下架、房源详情、收藏/对比、房源标签（学区/地铁）管理     |
| 订单服务（Order）| 预约看房订单、带看记录、订单状态流转、评价管理                           |
| 搜索服务（Search）| 房源数据同步ES、多条件筛选、模糊搜索、排序（价格/发布时间）               |
| 消息服务（Message）| 短信通知、小程序订阅消息、站内信、消息推送                               |
| 统计服务（Stat）| 平台数据（房源/用户/订单量）、商家数据（流量/预约量）、报表导出           |
| 管理服务（Admin）| 后台审核、系统配置、违规处理、运营数据监控                               |
| 支付服务（Pay）| （可选）商家保证金、服务费支付，集成微信支付                             |

### 2. 核心业务流程示例
#### （1）房源发布&审核流程
```
商家B端提交房源 → Gateway鉴权 → House Service保存房源（待审核）→ 发送MQ消息（待审核）
→ Message Service消费消息 → 推送审核通知给管理员 → 管理员审核（通过/驳回）
→ House Service更新房源状态 → 发送MQ消息（上架/驳回）→ Search Service同步ES（审核通过）
→ Message Service推送结果给商家 → 房源在C端展示（审核通过）
```

#### （2）房源搜索流程
```
C端用户输入筛选条件 → Gateway路由 → Search Service查询ES（返回房源ID列表）
→ 批量调用House Service获取房源核心信息 → 前端渲染列表 → 点击详情调用House Service获取完整信息
```

### 3. 数据层设计
#### （1）数据库设计
- 核心表：`user`（用户）、`merchant`（商家）、`house`（房源）、`house_label`（房源标签）、`order`（预约订单）、`message`（消息）；
- 分库分表：房源表按「城市」分库，订单表按「时间」分表（月/季度）；
- 主从复制：主库写、从库读（房源列表/搜索走从库），提升读性能。

#### （2）缓存设计
- 热点缓存：首页推荐房源、热门城市房源列表（缓存有效期10分钟，预热+定时刷新）；
- 用户缓存：用户信息、JWT Token（Token有效期2小时，刷新Token机制）；
- 防问题：缓存雪崩（过期时间随机）、缓存击穿（布隆过滤器）、缓存穿透（空值缓存）。

#### （3）ES索引设计
- 索引名：`house_{城市码}`（按城市拆分索引）；
- 字段：房源ID、标题、价格、户型、面积、朝向、小区、学区、地铁、发布时间等；
- 分词：IK分词器（中文小区名/地址模糊搜索）。

## 六、关键架构设计点
### 1. 高可用设计
- 服务多实例部署：每个微服务至少2个实例，K8s自动重启故障实例；
- 中间件集群：Redis集群、ES集群、RocketMQ集群，避免单点故障；
- 熔断降级：Sentinel配置接口熔断规则（失败率>50%触发熔断），返回兜底数据（如“暂无房源”）；
- 容灾备份：MySQL定时备份（每日）、OSS数据多副本、ES索引快照。

### 2. 高性能设计
- 接口优化：RESTful API，接口合并（减少前端请求次数），gzip压缩响应数据；
- 数据库优化：核心字段加索引（房源表的城市、价格、户型），慢查询监控与优化；
- 搜索优化：ES分页用`search after`（避免深分页），索引字段按需存储；
- 前端优化：小程序分包加载、图片压缩/懒加载、静态资源CDN。

### 3. 安全设计
- 认证授权：JWT Token（含签名，防篡改），RBAC权限模型（普通用户/商家/管理员）；
- 数据安全：密码BCrypt加密、敏感信息脱敏（手机号显示138****1234）、HTTPS传输；
- 防攻击：SQL注入（MyBatis-Plus参数绑定）、XSS（前端过滤+后端转义）、CSRF（Token校验）、接口限流（Gateway按IP限流，单机100QPS）；
- 操作审计：记录管理员审核、商家发布房源的操作日志，便于追溯。

### 4. 扩展性设计
- 业务扩展：微服务模块化，新增“租赁服务”“新房服务”只需新增模块，不影响现有服务；
- 技术扩展：预留第三方接口（高德/百度地图、第三方房源数据、支付渠道）；
- 容量扩展：K8s自动扩缩容（CPU>80%扩容），数据库分库分表横向扩容。

## 七、部署架构
### 1. 环境划分
| 环境       | 部署方式                          | 说明                     |
|------------|-----------------------------------|--------------------------|
| 开发环境   | 本地+测试服务器（单节点）| 开发调试，中间件单实例   |
| 测试环境   | K8s集群（3节点）| 模拟生产，中间件集群     |
| 生产环境   | 云服务器（阿里云/腾讯云）+ K8s集群（多可用区） | 高可用，容灾备份         |

### 2. 生产部署拓扑
```
用户 → CDN（静态资源/OSS文件）→ SLB（负载均衡）→ Gateway集群 → 微服务集群（K8s）
→ 中间件集群（Nacos/Redis/ES/RocketMQ）→ MySQL主从 → 存储（OSS）
```

## 八、项目实施计划
| 阶段         | 周期   | 核心工作                                                                 |
|--------------|--------|--------------------------------------------------------------------------|
| 需求&架构设计 | 1-2周  | 需求评审、架构设计文档、接口文档、数据库设计                             |
| 基础框架搭建 | 2周    | 微服务框架搭建、中间件部署、网关配置、前端基础模板                       |
| 核心模块开发 | 4-6周  | 按服务拆分开发（用户→房源→订单→搜索→消息），前端小程序/管理后台开发     |
| 测试&联调    | 2-3周  | 单元测试、集成测试、性能测试（JMeter）、安全测试、前后端联调             |
| 上线部署     | 1周    | 生产环境部署、灰度发布（10%流量）、监控上线状态                         |
| 运维&迭代    | 持续   | 监控告警、Bug修复、用户反馈迭代、性能优化                               |

## 九、风险与应对
| 风险点               | 应对策略                                                                 |
|----------------------|--------------------------------------------------------------------------|
| 高峰期高并发         | 接口限流、热点数据缓存、K8s自动扩容、ES查询优化                         |
| MySQL与ES数据不一致  | MQ重试机制（3次）、定时任务（每小时）校验同步数据，不一致自动修复         |
| 服务宕机             | 多实例部署、K8s重启容器、Sentinel熔断降级，核心接口兜底返回             |
| 数据泄露             | 定期安全扫描、敏感数据脱敏、权限最小化、操作审计日志                     |
| 小程序审核风险       | 提前适配微信小程序规范，避免违规内容（如虚假房源），预留审核申诉流程     |

## 十、总结
本架构基于Java微服务+前后分离，适配房产小程序的核心场景，兼顾高可用、高性能与扩展性，同时通过缓存、ES、MQ等中间件解决房产行业的“搜索慢、并发高、数据量大”痛点。后续可根据业务增长，逐步扩展分库分表、多地域部署、AI推荐房源等能力。